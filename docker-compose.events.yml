# Event Brokers Configuration
# Usage: docker compose -f docker-compose.yml -f docker-compose.events.yml up -d
#
# Event Infrastructure for ngVLA Phase 3.5 Broker Comparison:
# - ZooKeeper: Coordination backend for Kafka
# - RabbitMQ: Ephemeral real-time messaging (<10ms latency)
# - Kafka: Durable audit trail (90-day retention, immutable log)
# - Pulsar: Alternative async broker with distributed ledger storage

services:
  # ============================================================================
  # ZOOKEEPER (Coordination for Kafka)
  # ============================================================================
  cosmic-horizons-zookeeper:
    image: confluentinc/cp-zookeeper:7.6.0
    container_name: cosmic-horizons-zookeeper
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    ports:
      - "127.0.0.1:2181:2181"
    volumes:
      - cosmic-horizons-zookeeper-data:/var/lib/zookeeper/data
    networks:
      - cosmic-horizons-network
    restart: unless-stopped
    healthcheck:
      test: echo stat | nc localhost 2181
      interval: 10s
      timeout: 5s
      retries: 5

  # ============================================================================
  # KAFKA (Durable Audit Trail - 90 Day Retention)
  # ============================================================================
  cosmic-horizons-kafka:
    image: confluentinc/cp-kafka:7.6.0
    container_name: cosmic-horizons-kafka
    depends_on:
      cosmic-horizons-zookeeper:
        condition: service_healthy
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: cosmic-horizons-zookeeper:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://cosmic-horizons-kafka:29092,PLAINTEXT_HOST://127.0.0.1:${KAFKA_PORT:-9092}
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: 'true'
      KAFKA_LOG_RETENTION_HOURS: 2160
      KAFKA_LOG_RETENTION_BYTES: 1099511627776
      # Enable remote JMX for Prometheus JMX exporter (local/dev only)
      KAFKA_JMX_OPTS: '-Dcom.sun.management.jmxremote=true -Dcom.sun.management.jmxremote.rmi.port=9999 -Dcom.sun.management.jmxremote.port=9999 -Dcom.sun.management.jmxremote.local.only=false -Dcom.sun.management.jmxremote.authenticate=false -Dcom.sun.management.jmxremote.ssl=false -Djava.rmi.server.hostname=cosmic-horizons-kafka'
    ports:
      - "127.0.0.1:${KAFKA_PORT:-9092}:9092"
      - "127.0.0.1:9999:9999"   # JMX port (for jmx-prometheus-exporter sidecar)
    volumes:
      - cosmic-horizons-kafka-data:/var/lib/kafka/data
    networks:
      cosmic-horizons-network:
        aliases:
          - kafka
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "sh", "-c", "nc -z localhost 9092"]
      interval: 5s
      timeout: 10s
      retries: 20
      start_period: 30s

  # ==========================================================================
  # Kafka Prometheus exporter (optional)
  # - Exposes /metrics on port 9308 for Prometheus scraping and local dev
  # - Set KAFKA_METRICS_URL=http://localhost:9308/metrics in your environment
  # ==========================================================================
  cosmic-horizons-kafka-exporter:
    image: danielqsj/kafka-exporter:latest
    container_name: cosmic-horizons-kafka-exporter
    depends_on:
      cosmic-horizons-kafka:
        condition: service_healthy
    environment:
      # Common env names (some exporter builds expect different variables) â€” provide all.
      - KAFKA_BROKERS=cosmic-horizons-kafka:29092
      - KAFKA_URI=cosmic-horizons-kafka:29092
      - KAFKA_SERVER=cosmic-horizons-kafka:29092
      - LOG_LEVEL=info
    ports:
      - "127.0.0.1:9308:9308"
    networks:
      - cosmic-horizons-network
    restart: unless-stopped

  # ==========================================================================
  # Kafka JMX-exporter (prometheus jmx_prometheus_httpserver sidecar)
  # - Scrapes Kafka JMX and exposes Prometheus metrics (including request latency p99)
  # - Exposes /metrics on port 9404
  # ==========================================================================
  cosmic-horizons-kafka-jmx-exporter:
    # Use a widely available jmx_prometheus_httpserver image (wrouesnel) instead of unavailable justwatch image
    image: wrouesnel/jmx_prometheus_httpserver:0.16.0
    container_name: cosmic-horizons-kafka-jmx-exporter
    depends_on:
      cosmic-horizons-kafka:
        condition: service_healthy
    volumes:
      - ./docker/kafka-jmx-exporter-config.yml:/etc/jmx-exporter/config.yml:ro
    ports:
      - "127.0.0.1:9404:9404"
    networks:
      - cosmic-horizons-network
    restart: unless-stopped
    # port, config-file, and target-jmx-host:port
    command: ["9404", "/etc/jmx-exporter/config.yml", "cosmic-horizons-kafka:9999"]

  # ============================================================================
  # RABBITMQ (Ephemeral Real-time Messaging)
  # ============================================================================
  cosmic-horizons-rabbitmq:
    image: rabbitmq:3.13-management-alpine
    container_name: cosmic-horizons-rabbitmq
    environment:
      RABBITMQ_DEFAULT_USER: guest
      RABBITMQ_DEFAULT_PASS: guest
      RABBITMQ_DEFAULT_VHOST: /
    ports:
      - "127.0.0.1:5672:5672"       # AMQP protocol
      - "127.0.0.1:15672:15672"     # Management UI
    volumes:
      - cosmic-horizons-rabbitmq-data:/var/lib/rabbitmq
    networks:
      - cosmic-horizons-network
    restart: unless-stopped
    healthcheck:
      test: rabbitmq-diagnostics -q ping
      interval: 10s
      timeout: 5s
      retries: 5

  # ============================================================================
  # PULSAR STANDALONE (Alternative Async Broker)
  # ============================================================================
  pulsar-standalone:
    image: apachepulsar/pulsar:latest
    container_name: cosmic-horizons-pulsar-standalone
    environment:
      PULSAR_MEM: "-Xms1g -Xmx1g"
      PULSAR_GC: "-XX:+UseG1GC -XX:MaxGCPauseMillis=10"
    ports:
      - "6650:6650"   # Pulsar broker protocol
      - "8080:8080"   # HTTP REST API
      - "8081:8081"   # WebSocket
    volumes:
      - pulsar-standalone-data:/var/lib/pulsar
    networks:
      - cosmic-horizons-network
    command: bin/pulsar standalone
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/admin/v2/brokers/healthy"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 15s

volumes:
  cosmic-horizons-zookeeper-data:
    driver: local
  cosmic-horizons-rabbitmq-data:
    driver: local
  cosmic-horizons-kafka-data:
    driver: local
  pulsar-standalone-data:
    driver: local

networks:
  cosmic-horizons-network:
    driver: bridge
