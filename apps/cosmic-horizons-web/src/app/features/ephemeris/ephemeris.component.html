<div class="ephemeris-container">
  <mat-toolbar color="primary" class="app-toolbar">
    <mat-icon class="brand-icon">satellite_alt</mat-icon>
    <span class="brand">Cosmic Horizon</span>
    <span class="spacer"></span>
    @if (user.username) {
      <a mat-button routerLink="/profile">
        <mat-icon>account_circle</mat-icon>
        My Profile
      </a>
    }
    <button mat-flat-button color="warn" (click)="logout()">
      <mat-icon>logout</mat-icon>
      Logout
    </button>
  </mat-toolbar>

  <div class="content-wrapper">
    <section class="page-header">
      <h1>Ephemeris Search</h1>
      <p class="subtitle">
        Resolve live coordinates for planets, moons, and small bodies, then
        preview the sky position instantly.
      </p>
    </section>

    <mat-card class="panel search-card">
      <mat-card-header>
        <mat-card-title>Target Query</mat-card-title>
      </mat-card-header>

      <mat-card-content>
        @if (error) {
          <div class="alert error" role="alert" aria-live="polite">
            <mat-icon>error</mat-icon>
            <div>
              <strong>Search Failed</strong>
              <p>{{ error }}</p>
            </div>
          </div>
        }

        @if (noResultsMessage) {
          <div class="alert warn" role="status" aria-live="polite">
            <mat-icon>warning</mat-icon>
            <div>
              <strong>No Results</strong>
              <p>{{ noResultsMessage }}</p>
            </div>
          </div>
        }

        <form
          [formGroup]="searchForm"
          (ngSubmit)="onSubmit()"
          class="search-form"
        >
          <div class="form-row">
            <mat-form-field class="search-field" appearance="outline">
              <mat-label>Target</mat-label>
              <input
                matInput
                formControlName="target"
                placeholder="mars, jupiter, moon, ceres"
                [attr.aria-invalid]="f['target'].invalid && submitted"
              />
              @if (f['target'].invalid && submitted) {
                <mat-error
                  >Target name is required (minimum 2 characters)</mat-error
                >
              }
            </mat-form-field>

            <mat-form-field class="epoch-field" appearance="outline">
              <mat-label>Epoch (optional)</mat-label>
              <input matInput formControlName="epoch" type="datetime-local" />
              <mat-hint>Leave blank to use current UTC time</mat-hint>
            </mat-form-field>
          </div>

          <div class="form-actions">
            <button
              mat-raised-button
              color="primary"
              type="submit"
              [disabled]="loading"
            >
              @if (loading) {
                <mat-spinner diameter="20"></mat-spinner>
              } @else {
                <mat-icon>search</mat-icon>
              }
              <span>Resolve</span>
            </button>

            @if (submitted && (result || error || noResultsMessage)) {
              <button
                mat-stroked-button
                type="button"
                (click)="clearSearch()"
                [disabled]="loading"
              >
                <mat-icon>clear</mat-icon>
                Reset
              </button>
            }
          </div>
        </form>
      </mat-card-content>
    </mat-card>

    @if (result) {
      <mat-card class="panel results-card">
        <mat-card-header>
          <mat-card-title>{{ result.target | titlecase }}</mat-card-title>
        </mat-card-header>

        <mat-card-content>
          <div class="results-layout">
            <div class="result-grid">
              <div class="result-item">
                <span class="label">Epoch (UTC)</span>
                <span class="value">{{ result.epoch }}</span>
              </div>
              <div class="result-item">
                <span class="label">Right Ascension</span>
                <span class="value mono"
                  >{{ result.ra | number: '1.6-6' }}°</span
                >
              </div>
              <div class="result-item">
                <span class="label">Declination</span>
                <span class="value mono"
                  >{{ result.dec | number: '1.6-6' }}°</span
                >
              </div>
              <div class="result-item">
                <span class="label">Accuracy</span>
                <span class="value mono"
                  >±{{ result.accuracy_arcsec | number: '1.3-3' }}&quot;</span
                >
              </div>
              <div class="result-item">
                <span class="label">Object Type</span>
                <span class="value">{{ result.object_type | titlecase }}</span>
              </div>
              <div class="result-item">
                <span class="label">Source</span>
                <span class="value">{{ result.source | titlecase }}</span>
              </div>
            </div>

            <div class="preview-card">
              <h3>Sky Preview</h3>
              @if (previewImageUrl) {
                <img
                  [src]="previewImageUrl"
                  [alt]="'Sky preview around ' + result.target"
                  loading="lazy"
                />
              } @else {
                <div class="preview-empty">Preview unavailable</div>
              }
              <div class="preview-actions">
                <button
                  mat-stroked-button
                  type="button"
                  (click)="openInViewer()"
                >
                  <mat-icon>open_in_new</mat-icon>
                  Open In Viewer
                </button>
                @if (result.aladin_url) {
                  <a
                    mat-button
                    [href]="result.aladin_url"
                    target="_blank"
                    rel="noopener noreferrer"
                  >
                    <mat-icon>travel_explore</mat-icon>
                    Open Aladin
                  </a>
                }
              </div>
            </div>
          </div>
        </mat-card-content>
      </mat-card>
    }

    <mat-card class="panel info-card">
      <mat-card-header>
        <mat-card-title>About This Data</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <ul>
          <li>
            <strong>RA/Dec:</strong> Position on the celestial sphere in
            degrees.
          </li>
          <li>
            <strong>Source:</strong> Results are served from astronomy-engine,
            JPL Horizons fallback, or cache.
          </li>
          <li>
            <strong>Preview:</strong> The image is a sky cutout centered on
            computed coordinates at the selected epoch.
          </li>
        </ul>
      </mat-card-content>
    </mat-card>
  </div>
</div>
