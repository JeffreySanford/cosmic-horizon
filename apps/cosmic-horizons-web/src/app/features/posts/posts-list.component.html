<div class="posts-page">
  <mat-toolbar color="primary" class="posts-toolbar">
    <mat-icon>menu_book</mat-icon>
    <span>Community Research Notebook</span>
    <span class="spacer"></span>
    <button mat-button type="button" (click)="createDraft()">
      <mat-icon>add_circle</mat-icon>
      New Draft
    </button>
    @if (canModerate) {
      <button mat-button type="button" class="moderation-btn" (click)="openModeration()">
        <mat-icon>gavel</mat-icon>
        Moderation
      </button>
    }
  </mat-toolbar>

  <section class="posts-content">
    <section class="list-controls">
      <mat-form-field appearance="outline">
        <mat-label>Search posts</mat-label>
        <input
          matInput
          [ngModel]="filterValue"
          (ngModelChange)="applyFilter($event)"
          placeholder="Title, author, status, content"
        />
      </mat-form-field>
      <mat-form-field appearance="outline">
        <mat-label>Sort by</mat-label>
        <select
          matNativeControl
          [(ngModel)]="sortBy"
          (ngModelChange)="onSortModeChange()"
        >
          <option value="recent">Recent</option>
          <option value="author">Author</option>
          <option value="title">Title</option>
        </select>
      </mat-form-field>
      <mat-checkbox [(ngModel)]="onlyMine" (ngModelChange)="onToggleOnlyMine()">
        My posts only
      </mat-checkbox>
    </section>

    @if (loading) {
      <p>Loading published posts...</p>
    } @else if (errorMessage) {
      <p class="error">{{ errorMessage }}</p>
    } @else if (visiblePosts.length === 0) {
      <div class="empty-state">
        <h3>Welcome to the Notebook</h3>
        <p>
          No posts match this view yet. Start by drafting your first discovery.
        </p>
        <button
          mat-flat-button
          color="accent"
          type="button"
          (click)="createDraft()"
        >
          Create a Draft
        </button>
      </div>
    } @else {
      <mat-card class="table-shell">
        <div class="table-wrapper">
          <table mat-table [dataSource]="dataSource" matSort class="posts-table">
            <ng-container matColumnDef="title">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>Title</th>
              <td mat-cell *matCellDef="let post">
                <div class="title-cell">
                  <span
                    class="status-badge"
                    [class.draft]="post.status === 'draft'"
                    [class.published]="post.status === 'published'"
                  >
                    {{ post.status }}
                  </span>
                  <span>{{ post.title }}</span>
                </div>
              </td>
            </ng-container>

            <ng-container matColumnDef="author">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>Author</th>
              <td mat-cell *matCellDef="let post">
                {{ authorName(post) }}
              </td>
            </ng-container>

            <ng-container matColumnDef="status">
              <th mat-header-cell *matHeaderCellDef>Status</th>
              <td mat-cell *matCellDef="let post">
                {{ post.hidden_at ? 'Hidden' : (post.status | titlecase) }}
              </td>
            </ng-container>

            <ng-container matColumnDef="updated">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>Updated</th>
              <td mat-cell *matCellDef="let post">
                {{ post.updated_at | date: 'medium' }}
              </td>
            </ng-container>

            <ng-container matColumnDef="published">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>Published</th>
              <td mat-cell *matCellDef="let post">
                {{
                  post.published_at
                    ? (post.published_at | date: 'mediumDate')
                    : 'n/a'
                }}
              </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
            <tr
              mat-row
              *matRowDef="let row; columns: displayedColumns"
              class="data-row"
              (click)="openPost(row)"
              tabindex="0"
            ></tr>
          </table>
        </div>

        <mat-paginator
          [length]="dataSource.data.length"
          [pageSize]="pageSize"
          [pageSizeOptions]="pageSizeOptions"
          showFirstLastButtons
        ></mat-paginator>
      </mat-card>
    }
  </section>
</div>
